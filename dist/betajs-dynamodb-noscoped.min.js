/*!
betajs-dynamodb - v1.0.13 - 2019-02-18
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/

(function(){var a=this.subScope();a.binding("module","global:BetaJS.Data.Databases.Dynamo"),a.binding("base","global:BetaJS"),a.binding("data","global:BetaJS.Data"),a.define("module:",function(){return{guid:"1f507e0c-602b-4372-b067-4e19442f28f4",version:"1.0.13",datetime:1550520855659}}),a.assumeVersion("base:version","~1.0.96"),a.assumeVersion("data:version","~1.0.41"),a.define("module:DynamoDatabaseTable",["data:Databases.DatabaseTable","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(){a.constructor.apply(this,arguments),this._table_options=this._table_options||[],this._table_options.idkeys=this._table_options.idkeys||[],this._table_options.idkeys.unshift("_id"),this._table_options.datekeys=this._table_options.datekeys||[]},table:function(){return this.__table?b.create(this.__table):this._database.dynamodb().mapSuccess(function(a){return this.__table={params:{TableName:this._table_name},obj:a},this.__table},this)},primary_key:function(){return"_id"},_encode:function(a,b){if(!a)return a;a=c.map(a,function(a,c){return a&&d.is_object(a)&&!a._bsontype?(this._table_options.datekeys.forEach(function(a){a===c&&(b="date")}),this._encode(a,b)):"date"===b?new Date(a):a},this);var e=this._database.dynamo_object_id();return this._table_options.idkeys.forEach(function(b){b in a&&!d.is_object(a[b])&&(a[b]=new e(a[b]+""))},this),this._table_options.datekeys.forEach(function(b){b in a&&!d.is_object(a[b])&&(a[b]=new Date(a[b]))},this),a},_decode:function(a){return a=c.clone(a,1),this._table_options.idkeys.forEach(function(b){b in a&&d.is_object(a[b])&&(a[b]=a[b]+"")},this),this._table_options.datekeys.forEach(function(b){b in a&&d.is_object(a[b])&&(a[b]=a[b].getTime())},this),a},_find:function(a,c){return this.table().mapSuccess(function(d){return b.funcCallback(d,d.find,a).mapSuccess(function(a){return c=c||{},"sort"in c&&(a=a.sort(c.sort)),"skip"in c&&(a=a.skip(c.skip)),"limit"in c&&(a=a.limit(c.limit)),b.funcCallback(a,a.toArray).mapSuccess(function(a){return new e(a)},this)},this)},this)},_findOne:function(a){return this.table().mapSuccess(function(d){const e=c.extend(d.params,{Key:a});return b.funcCallback(d.obj,d.obj.get,e).mapSuccess(function(a){return a},this)},this)},_count:function(a){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.find,a).mapSuccess(function(a){return b.funcCallback(a,a.count)})})},_insertRow:function(a){return this.table().mapSuccess(function(d){const e=c.extend(d.params,{Item:a});return b.funcCallback(d.obj,d.obj.put,e).mapSuccess(function(a){return a},this)},this)},_insertRows:function(a){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.insertMany,a).mapSuccess(function(a){return row},this)},this)},_removeRow:function(a){return this.table().mapSuccess(function(d){const e=c.extend(d.params,{Key:a});return b.funcCallback(d.obj,d.obj.delete,e)},this)},_removeRows:function(a){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.deleteMany,a)},this)},_updateRow:function(a,c){return this.table().mapSuccess(function(d){return b.funcCallback(d,d.updateOne,a,{$set:c}).mapSuccess(function(){return c})},this)},ensureIndex:function(a){({})[a]=1,this.table().success(function(b){b.ensureIndex(c.objectBy(a,1))})},_renameTable:function(a){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.rename,a)})}}})}),a.define("module:DynamoDatabase",["data:Databases.Database","module:DynamoDatabaseTable","base:Strings","base:Types","base:Objs","base:Promise","base:Net.Uri"],function(a,b,c,d,e,f,g,h){return a.extend({scoped:h},function(a){return{constructor:function(b){a.constructor.call(this);const c=require("aws-sdk");c.config.update(b),this.dynamo_module=c},_tableClass:function(){return b},dynamo_object_id:function(a){},generate_object_id:function(a){},dynamodb:function(){return this.__dynamodb?f.value(this.__dynamodb):(this.__dynamodb=new this.dynamo_module.DynamoDB,this.__client=new this.dynamo_module.DynamoDB.DocumentClient,f.value(this.__client))},destroy:function(){this.__dynamodb&&(this.__dynamodb=null),this.__client&&(this.__client=null),a.destroy.call(this)}}},{uriToObject:function(a){},objectToUri:function(a){}})})}).call(Scoped);