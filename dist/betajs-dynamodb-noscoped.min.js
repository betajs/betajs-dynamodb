/*!
betajs-dynamodb - v1.0.2 - 2019-02-27
Copyright (c) Oliver Friedmann,Pablo Iglesias
Apache-2.0 Software License.
*/

"use strict";(function(){var a=this.subScope();a.binding("module","global:BetaJS.Data.Databases.DynamoDB"),a.binding("base","global:BetaJS"),a.binding("data","global:BetaJS.Data"),a.define("module:",function(){return{guid:"1f507e0c-602b-4372-b067-4e19442f28f4",version:"1.0.2",datetime:1551300756188}}),a.assumeVersion("base:version","~1.0.96"),a.assumeVersion("data:version","~1.0.41"),a.define("module:DynamoDatabaseTable",["data:Databases.DatabaseTable","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(){a.constructor.apply(this,arguments),this._table_options=this._table_options||[],this._table_options.idkeys=this._table_options.idkeys||[],this._table_options.idkeys.unshift("_id"),this._table_options.datekeys=this._table_options.datekeys||[]},table:function(){return this.__table?b.create(this.__table):this._database.dynamodb().mapSuccess(function(a){return this.__table={params:{TableName:this._table_name},client:a.client},this.__table},this)},primary_key:function(){return"_id"},_encode:function(a,b){return a},_decode:function(a){return a},_find:function(a,c){return this.table().mapSuccess(function(d){var f=this.__queryParams(a,c),g=Object.assign({},d.params,f);return b.funcCallback(d.client,d.client.query,g).mapSuccess(function(a){return new e(a.Items)},this)},this)},_findOne:function(a){return this.table().mapSuccess(function(c){var d=Object.assign({},c.params,{Key:a});return b.funcCallback(c.client,c.client.get,d).mapSuccess(function(a){return a.Item},this)},this)},_count:function(a){return this.table().mapSuccess(function(c){var d=this.__queryParams(a,options),f=Object.assign({},c.params,d);return b.funcCallback(c.client,c.client.query,f).mapSuccess(function(a){return new e(a.Count)},this)},this)},_insertRow:function(a){return this.table().mapSuccess(function(c){var d=Object.assign({},c.params,{Item:a});return b.funcCallback(c.client,c.client.put,d).mapSuccess(function(a){return a},this)},this)},_removeRow:function(a){return this.table().mapSuccess(function(c){var d=Object.assign({},c.params,{Key:a,ReturnValues:"NONE"});return b.funcCallback(c.client,c.client.delete,d).mapSuccess(function(a){return a})},this)},_updateRow:function(a,c){return this.table().mapSuccess(function(d){var e=this.__updateParams(c),f=Object.assign({},d.params,{Key:a,ReturnValues:"ALL_NEW"});return f=Object.assign({},f,e),b.funcCallback(d.client,d.client.update,f).mapSuccess(function(a){return a},this)},this)},ensureIndex:function(a){({})[a]=1,this.table().success(function(b){b.ensureIndex(c.objectBy(a,1))})},__updateParams:function(a){var b=Object.assign({},a),d=[],e=[];return c.iter(b,function(a,b){var c=Math.floor(10*Math.random()+1);d.push("".concat(b," = :").concat(c)),e[":".concat(c)]=a}),{UpdateExpression:"set "+d.join(",  "),ExpressionAttributeValues:e}},__queryParams:function(a,b){var e=Object.assign({},a),f=[],g=[],h=[],i=[];return c.iter(e.keyConditions,function(a,b){if(d.is_object(a)){var e=c.keys(a).join();if("begins_with"!==e){var g="";switch(e){case"ne":g="!=";break;default:g="="}f.push("#".concat(b," ").concat(g," :").concat(b))}else f.push("begins_with(#".concat(b,", :").concat(b,")"));h["#".concat(b)]=b,i[":".concat(b)]=c.values(a)[0]}else f.push("#".concat(b," = :").concat(b)),h["#".concat(b)]=b,i[":".concat(b)]=a}),c.iter(e.filterExpression,function(a,b){if(d.is_object(a)){var e=c.keys(a).join();"begins_with"!==e?g.push("#".concat(b," ").concat(e," :").concat(b)):g.push("begins_with(#".concat(b,", :").concat(b,")")),h["#".concat(b)]=b,i[":".concat(b)]=c.values(a)[0]}else g.push("#".concat(b," = :").concat(b)),h["#".concat(b)]=b,i[":".concat(b)]=a}),{KeyConditionExpression:f.join(" and "),FilterExpression:g.join(" and "),ExpressionAttributeNames:h,ExpressionAttributeValues:i}}}})}),a.define("module:DynamoDatabase",["data:Databases.Database","module:DynamoDatabaseTable","base:Strings","base:Types","base:Objs","base:Promise","base:Net.Uri"],function(a,b,c,d,e,f,g,h){return a.extend({scoped:h},function(a){return{constructor:function(b){a.constructor.call(this);var c=require("aws-sdk");c.config.update(b),this.dynamo_module=c},dynamodb:function(){return this.__objects?f.value(this.__objects):(this.__dynamodb=new this.dynamo_module.DynamoDB,this.__client=new this.dynamo_module.DynamoDB.DocumentClient,this.__objects={database:this.__dynamodb,client:this.__client},f.value(this.__objects))},createTable:function(a){return this.dynamodb().mapSuccess(function(b){return f.funcCallback(b.database,b.database.createTable,a).mapSuccess(function(a){return a},this)},this)},deleteTable:function(a){var b={TableName:a};return this.dynamodb().mapSuccess(function(a){return f.funcCallback(a.database,a.database.deleteTable,b).mapSuccess(function(a){return a},this)},this)},_tableClass:function(){return b},dynamo_object_id:function(a){},generate_object_id:function(a){},destroy:function(){this.__dynamodb&&(this.__dynamodb=null),this.__client&&(this.__client=null),a.destroy.call(this)}}},{})})}).call(Scoped);