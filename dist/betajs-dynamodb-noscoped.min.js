/*!
betajs-dynamodb - v1.0.4 - 2020-06-04
Copyright (c) Oliver Friedmann,Pablo Iglesias
Apache-2.0 Software License.
*/

"use strict";(function(){var a=this.subScope();a.binding("module","global:BetaJS.Data.Databases.DynamoDB"),a.binding("base","global:BetaJS"),a.binding("data","global:BetaJS.Data"),a.define("module:",function(){return{guid:"1f507e0c-602b-4372-b067-4e19442f28f4",version:"1.0.4",datetime:1591244758425}}),a.assumeVersion("base:version","~1.0.96"),a.assumeVersion("data:version","~1.0.41"),a.define("module:DynamoDatabaseTable",["data:Databases.DatabaseTable","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator","base:Iterators.SkipIterator","data:Queries","base:Classes.CacheHash"],function(a,b,c,d,e,f,g,h,i){return a.extend({scoped:i},function(a){var i={$gte:">=",$lte:"<=",$gt:">",$lt:"<"};return{constructor:function(){a.constructor.apply(this,arguments),this._table_options.locals=this._table_options.locals||[],this._table_options.globals=this._table_options.globals||[]},_deleteTable:function(a){return this.dynamodb().mapSuccess(function(c){return b.funcCallback(c.database,c.database.deleteTable,{TableName:a}).mapSuccess(function(a){return a},this)},this)},_createTable:function(a){var d=[{AttributeName:this._table_options.primary.hash,KeyType:"HASH"}];this._table_options.primary.range&&d.push({AttributeName:this._table_options.primary.range,KeyType:"RANGE"});var e={TableName:a,BillingMode:"PAY_PER_REQUEST",AttributeDefinitions:c.arrayify(this._table_options.attributes,function(a,b){return{AttributeName:b,AttributeType:a}}),KeySchema:d};return this._table_options.locals.length>0&&(e.LocalSecondaryIndexes=this._table_options.locals.map(function(a){return{IndexName:[this._table_options.primary.hash,a].join("_"),KeySchema:[{AttributeName:this._table_options.primary.hash,KeyType:"HASH"},{AttributeName:a,KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}}},this)),this._table_options.globals.length>0&&(e.GlobalSecondaryIndexes=this._table_options.globals.map(function(a){return{IndexName:[a.hash,a.range].join("_"),KeySchema:[{AttributeName:a.hash,KeyType:"HASH"},{AttributeName:a.range,KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}}})),this.dynamodb().mapSuccess(function(a){return b.funcCallback(a.database,a.database.createTable,e)},this)},dynamodb:function(){return this._database.dynamodb()},table:function(){return this.__table?b.create(this.__table):this.dynamodb().mapSuccess(function(a){return this.__table={params:{TableName:this._table_name},client:a.client},this.__table},this)},_insertRow:function(a){return this.table().mapSuccess(function(c){return b.funcCallback(c.client,c.client.put,Object.assign({},c.params,{Item:a})).mapSuccess(function(a){return a},this)},this)},primary_key:function(){return this._table_options.primary.hash},_removeRow:function(a){return this._table_options.primary.hash in a&&(!this._table_options.primary.range||this._table_options.primary.range in a)?this.table().mapSuccess(function(c){var d={};return d[this._table_options.primary.hash]=a[this._table_options.primary.hash],this._table_options.primary.range&&(d[this._table_options.primary.range]=a[this._table_options.primary.range]),b.funcCallback(c.client,c.client.delete,Object.assign({},c.params,{Key:d,ReturnValues:"NONE"}))},this):this._findOne(a).mapSuccess(this._removeRow,this)},_updateRow:function(a,d){return this._table_options.primary.hash in a&&(!this._table_options.primary.range||this._table_options.primary.range in a)?this.table().mapSuccess(function(e){var f={};return f[this._table_options.primary.hash]=a[this._table_options.primary.hash],this._table_options.primary.range&&(f[this._table_options.primary.range]=a[this._table_options.primary.range]),b.funcCallback(e.client,e.client.update,Object.assign({},e.params,{Key:f,AttributeUpdates:c.map(d,function(a){return{ACTION:"PUT",Value:a}}),ReturnValues:"ALL_NEW"})).mapSuccess(function(a){return a},this)},this):this._findOne(a).mapSuccess(function(a){return this._updateRow(a,d)},this)},_find:function(a,j){return this.table().mapSuccess(function(k){var l=new h("#n"),m=new h(":v");j=j||{};var n=this._table_options.primary,o={};if(g.isEqualValueKey(a,n.hash)&&(!n.range||g.isEqualValueKey(a,n.range))){if(j.skip>0)return b.value([]);var p=c.splitObject(a,function(a,b){return b===n.hash||b===n.range});return a=p[0],o=p[1],b.funcCallback(k.client,k.client.get,Object.assign({},k.params,{Key:a})).mapSuccess(function(a){return a=a&&a.Item&&g.evaluate(o,a.Item)?[a.Item]:[],new e(a)},this)}var q=[];n.range&&q.push({index:void 0,hash:n.hash,range:n.range}),this._table_options.locals.forEach(function(a){q.push({index:[n.hash,a].join("_"),hash:n.hash,range:a})}),this._table_options.globals.forEach(function(a){q.push({index:[a.hash,a.range].join("_"),hash:a.hash,range:a.range})});for(var r=0;r<q.length;++r){var s=q[r];if(g.isEqualValueKey(a,s.hash)&&s.range in a){var t=c.splitObject(a,function(a,b){return b===s.hash||b===s.range});a=t[0],o=t[1];var u=[];if(u.push([l.hashKey(s.hash),"=",m.hashKey(a[s.hash])]),g.isEqualValueKey(a,s.range))u.push([l.hashKey(s.range),"=",m.hashKey(a[s.range])]);else{var v=c.ithKey(a[s.range]),w=a[s.range][v],x=i[v];u.push([l.hashKey(s.range),x,m.hashKey(w)])}return b.funcCallback(k.client,k.client.query,Object.assign({},k.params,{IndexName:s.index,KeyConditionExpression:u.map(function(a){return a.join(" ")}).join(" and "),ExpressionAttributeNames:l.cache(),ExpressionAttributeValues:m.cache(),Limit:j.limit?j.limit+(j.skip||0):void 0,ScanIndexForward:!!j.sort})).mapSuccess(function(a){var b=a&&a.Items?a.Items:[];d.is_empty(o)||(b=b.filter(function(a){return g.evaluate(o,a)}));var c=new e(b);return j.skip>0?new f(c,j.skip):c},this)}}return b.error("Unsupported query")},this)}}})}),a.define("module:DynamoDatabase",["data:Databases.Database","module:DynamoDatabaseTable","base:Promise"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b){a.constructor.call(this),this.__db=b},dynamodb:function(){if(!this.__objects){var a=require("aws-sdk");this.__dynamodb=new a.DynamoDB(this.__db),this.__client=new a.DynamoDB.DocumentClient(this.__db),this.__objects={database:this.__dynamodb,client:this.__client}}return c.value(this.__objects)},_tableClass:function(){return b}}})})}).call(Scoped);